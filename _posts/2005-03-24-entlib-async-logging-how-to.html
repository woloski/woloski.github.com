--- 
layout: post
title: EntLib Async Logging - How to
published: true
meta: {}

tags: []

type: post
status: publish
---
<p></p>  <p>I've been experimenting with <a href="http://workspaces.gotdotnet.com/entlib">EntLib</a> Logging App Block. I wanted to do the async logging via MSMQ. </p>  <br />  <p>Async logging is one of the requirements of Enterprise Applications that does not want to waste cpu cycles logging on the Event Viewer or raising a WMI event or whatever logging strategy they use. Instead, a better approach is write the log message to a MSMQ and then have a service polling that queue that will do whatever with this log.</p>  <br />  <p>This way we could have our logging in a separate machine and the applications just write to a queue (which in turns much more fast compared to other things). Indeed we could write to a queue on the same machine. Here we could be more performant because the logging runs in a separate process (with a Windows Service, a Console app or whatever that polls the queue and get the log message).</p>  <br />  <p>Enterprise Library takes care of all this for us and we could have async logging setup in a matter of minutes.</p>  <br />  <p>I will show here what I did to get it running.</p>  <br />  <p><font size="3"><strong>Client Application</strong></font></p>  <br />  <p>First, we need to create the Logging Application Block for our application. Right Click on <strong>App -&gt; New -&gt; Logging and Instrumentation Application Block.</strong></p>  <br />  <p><a href="http://blogs.southworks.net/mwoloski/files/2008/06/ent1.gif"><img height="312" alt="ent1" src="http://blogs.southworks.net/mwoloski/files/2008/06/ent1-thumb.gif" width="414" border="0" /></a> </p>  <br />  <p>Then we need to remove some stuff that the client application won't use. The logging will be done by a separate service, no by the client application inprocess. We won't need the Distributor Settings and we don't need the InProcess distribution strategy. So right click on <strong>Distributor Settings -&gt; Remove. </strong>And Right click on <strong>InProcess -&gt; Remove.</strong></p>  <br />  <p><a href="http://blogs.southworks.net/mwoloski/files/2008/06/ent2.gif"><img height="303" alt="ent2" src="http://blogs.southworks.net/mwoloski/files/2008/06/ent2-thumb.gif" width="404" border="0" /></a> </p>  <br />  <p>Now, we need to add the MSMQ distribution strategy. Right click on <strong>Distribution Strategies -&gt; New -&gt; MSMQ. </strong>The MSMQ distribution strategy has a queue associated where the LogEntries will be throw. Click on MSMQ and modify the <strong>QueuePath</strong> to some message queue you want (<strong><em>remember to create the queue before using it</em></strong>!)</p>  <br />  <p><a href="http://blogs.southworks.net/mwoloski/files/2008/06/ent3.gif"><img height="314" alt="ent3" src="http://blogs.southworks.net/mwoloski/files/2008/06/ent3-thumb.gif" width="419" border="0" /></a> </p>  <br />  <p>Click on <strong>Client Settings</strong> and choose <strong>MSMQ</strong> on the <strong>DistributionStrategy property</strong>.</p>  <br />  <p><a href="http://blogs.southworks.net/mwoloski/files/2008/06/ent4.gif"><img height="308" alt="ent4" src="http://blogs.southworks.net/mwoloski/files/2008/06/ent4-thumb.gif" width="410" border="0" /></a> </p>  <br />  <p><font size="3"><strong>MSMQ Distributor Service</strong></font></p>  <br />  <p>EntLib provides a Windows Service (MsmqDistributor) that will poll the message queue within a configured interval and do the real logging. This service is not installed by default, nor via InstallServices batch. So we need to install it by ourselves.</p>  <br />  <p>Open a vs.net 2003 command prompt and do a </p>  <br />  <p><strong>cd [EntLibInstallDir]\bin\</strong></p>  <br />  <p>Then run the installutil</p>  <br />  <p><strong>installutil MsmqDistributor.exe</strong></p> <a href="http://blogs.southworks.net/mwoloski/files/2008/06/ent5.gif"><img height="217" alt="ent5" src="http://blogs.southworks.net/mwoloski/files/2008/06/ent5-thumb.gif" width="423" border="0" /></a>   <br />  <p>Now we need to configure the Logging block in the service. Think now that the service config file is like your client application. Remember that the async logging has two process running: the client application itself (winforms, web, whatever) and the service distributor (the service that will do the real logging).</p>  <br />  <p>You will need to copy two files required by the MsmqDistributor config otherwise there will be a validation error (it seems like the PAG guys forgot to include them in the bin directory). So copy these two files</p>  <br />  <p><strong>[EntLibInstallDir]\src\Logging\MSMQDistributor\loggingConfiguration.config </strong>to <strong>[EntLibInstallDir]\bin     <br />[EntLibInstallDir]\src\Logging\MSMQDistributor\loggingDistributorConfiguration.config to [EntLibInstallDir]\bin</strong></p>  <br />  <p>Now, open the <strong>[EntLibInstallDir]\bin\MsmqDistributor.exe.config</strong> with the EntLib console (you can use the same console that you were using for the client app, but if you are using separate machines obviously not :)</p>  <br />  <p><a href="http://blogs.southworks.net/mwoloski/files/2008/06/ent6.gif"><img height="347" alt="ent6" src="http://blogs.southworks.net/mwoloski/files/2008/06/ent6-thumb.gif" width="463" border="0" /></a> </p>  <br />  <p>(it seems they forgot to change a path there [C:\Depots\Microsoft\ELF2\QuickStarts\Logging\CS\LoggingQuickStart\App.config] ;)   <br />Let's configure the last thing! Right click on the <strong>Distributor Settings</strong> of the MsmqDistributor config file <strong>-&gt; New -&gt; MSMQ Distributor Service. </strong>This is the configuration that will tells the Windows Service which is the queue path where the logentries are being saved.    <br />You should set the <strong>QueuePath</strong> in the property grid to the same queue configured in the client app (if you want it to work of course ;)</p>  <br />  <p><a href="http://blogs.southworks.net/mwoloski/files/2008/06/ent7.gif"><img height="343" alt="ent7" src="http://blogs.southworks.net/mwoloski/files/2008/06/ent7-thumb.gif" width="454" border="0" /></a> </p>  <br />  <p>Finally, you can configure whatever you want regards Formatters, Sinks and Categories here. Remember to do it on the service and not the client!</p>  <br />  <p>Save All, start the service, start your application and enjoy Distributed Async Logging!</p>
