--- 
layout: post
title: Troubleshooting WS-Federation and SAML2 Protocol
published: true
meta: {}

tags: 
- ADFS
- Identity
- Windows Identity Foundation
type: post
status: publish
---
<p><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;float: right;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" align="right" src="http://blogs.southworks.net/mwoloski/files/2011/04/image20.png" width="130" height="128">During the last couple of years we have helped companies deploying federated identity solutions using WS-Fed and SAML2 protocols with products like ADFS, SiteMinder in various platforms. Claims-based identity has many benefits but as every solution it has its downsides. One of them is the additional complexity to troubleshoot issues if something goes wrong, especially when things are distributed and in production. Since the authentication is outsourced and it is not part of the application logic anymore you need someway to see what is happening behind the scenes.</p> <p>I’ve used <a href="http://www.fiddler2.com/fiddler2/">Fiddler</a> and <a href="https://addons.mozilla.org/en-us/firefox/addon/httpfox/">HttpHook</a> in the past to see what’s going on in the wire. These are great tools but they are developer-oriented. If the user who is having issues to login to an app is not a developer, then things get more difficult. </p> <ul> <li>Either you have some kind of server side log with all the tokens that have been issued and a nice way to query those by user</li> <li>Or you have some kind of tool that the user can run and intercept the token </li></ul> <p><a href="http://blogs.southworks.net/fboerr">Fred</a>, one of the guys working on my team, had the idea couple of months ago to implement the latter. So we coded together the first version (very rough) of the <strong>token debugger. </strong>The code is really simple, we are embedding a WebBrowser control in a Winforms app and inspecting the content on the Navigating event. If we detect a token being posted we show that.</p> <p>Let’s see how it works. First you enter the url of your app, in this case we are using wolof (the tool we use for the backlog) that is a Ruby app speaking WS-Fed protocol. .</p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/04/image27.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/04/image_thumb22.png" width="644" height="362"></a></p> <p>After clicking the Southworks logo and entering my Active Directory account credentials, ADFS returns the token and it is POSTed to the app. In that moment, we intercept it and show it.</p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/04/image28.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/04/image_thumb23.png" width="644" height="362"></a></p> <p>You can do two things with the token: <strong>send it via email </strong>(to someone that can read it <img style="border-bottom-style: none;border-left-style: none;border-top-style: none;border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="http://blogs.southworks.net/mwoloski/files/2011/04/wlEmoticon-smile.png">) or <strong>continue with the usual flow</strong>. If there is another STS in the way it will also show a second token.</p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/04/image24.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/04/image_thumb20.png" width="644" height="351"></a></p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/04/image26.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/04/image_thumb21.png" width="640" height="347"></a></p> <p>Since I wanted to have this app handy I enabled ClickOnce deployment and deployed it to <a href="http://appharbor.com/">AppHarbor</a> (which works really well btw)</p> <p>If you want to use it browse to and launch the ClickOnce app @ <a title="http://miller.apphb.com/" href="http://miller.apphb.com/">http://miller.apphb.com/</a></p> <p>If you want to download the source code or contribute @ <a title="https://github.com/federicoboerr/token-requestor" href="https://github.com/federicoboerr/token-requestor">https://github.com/federicoboerr/token-requestor</a></p>
