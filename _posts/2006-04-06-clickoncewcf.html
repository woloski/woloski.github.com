--- 
layout: post
title: ClickOnce and WCF
published: true
meta: {}

tags: 
- ClickOnce
- Indigo
type: post
status: publish
---
<p class="MsoNormal">I've been concerned about the relationship between <a href="http://msdn.microsoft.com/smartclient/understanding/windowsforms/2.0/features/clickonce.aspx">ClickOnce</a> and <a href="http://msdn.microsoft.com/webservices/indigo/default.aspx">WCF</a>. Lot of <a href="http://codebetter.com/blogs/sam.gentile/archive/2006/02/20/138774.aspx">buzz</a> <a href="http://www.douglasp.com/blog/PermaLink.aspx?guid=12a6b6d1-fc37-484b-b52e-92051a309b89">has</a> <a href="http://www.leastprivilege.com/TheOfficialWordOnWCFAndPartialTrust.aspx">been</a> <a href="http://friends.newtelligence.net/clemensv/PermaLink,guid,b99db04c-f2d0-4850-8d9f-8048608ea7cd.aspx">generated</a> regarding partial-trust scenario not being supported for <a href="http://msdn.microsoft.com/webservices/indigo/default.aspx">WCF</a> v1. I see this as something desirable, but it is not the end of the world :)</p>  <p>I've written a Smart Client application that leverage <a href="http://msdn.microsoft.com/webservices/indigo/default.aspx">WCF</a>.&#160; I wanted to deploy it so I choose <a href="http://msdn.microsoft.com/smartclient/understanding/windowsforms/2.0/features/clickonce.aspx">ClickOnce</a>. ClickOnce supports installing prerequisites as part of the whole process, so I downloaded <a href="http://msdn.microsoft.com/winfx/">WinFx</a> and include it as part of the installation. If you are insterested in how to do this, keep reading.</p>  <p class="MsoNormal"><a href="http://msdn.microsoft.com/webservices/indigo/default.aspx"><b>WCF</b></a> is part of    <br />the <a href="http://www.microsoft.com/downloads/details.aspx?familyid=F51C4D96-9AEA-474F-86D3-172BFA3B828B&amp;displaylang=en">WinFX Runtime Components</a>, which is currently in Beta 2 (Feb CTP). <b>The installation of this runtime requires     <br />Admin privileges</b> and the size of the Redistributable package is 45.3 MB.    <br />These are the alternatives to distribute it on client desktops:</p>  <ul style="margin-top: 0cm" type="disc">   <li class="MsoNormal">Install     <br />WinFx manually on each desktop :) </li>    <li class="MsoNormal">Use SMS     <br />to distribute WinFx </li>    <li class="MsoNormal">Include     <br />WinFx as part of the prerequisites of the ClickOnce application </li>    <li class="MsoNormal">Distrubute     <br />an MSI which includes WinFx </li> </ul>  <p>I was interested in the 3rd option, so let's analyze it further</p>  <h3><a name="_Toc129597695">Include WinFx as part of the prerequisites of the     <br />ClickOnce application</a></h3>  <p class="MsoNormal">ClickOnce has a feature that allows including the   <br />prerequisites of the application to be deployed. When the application is published    <br />it creates a setup bootstraper that will download and install all the    <br />prerequisites (if they were not installed yet) before the ClickOnce application    <br />is executed. This way the deployment will be more controlled as it will be a    <br />single package.</p>  <p class="MsoNormal">The user executing the setup bootstraper must have   <br />Admin    <br />privileges. If the user logged does not have Admin privileges, an    <br />option would    <br />be to execute Internet Explorer with &#226;&#8364;&#339;Run As&#226;&#8364;&#166;&#226;&#8364;¬ù and login with a local    <br />administrator account. This will at least install the prerequisites and    <br />also the application in the Administrator profile. Later you would need    <br />to open a new IE instance and launch the app again from the currently    <br />logged user.</p>  <p>The following sequence illustrates the install of</p>  <p>prerequisites (.Net Framework 2.0 and WinFx Beta 2)</p>  <p class="MsoNormal"><!--[if gte vml 1]&gt;-->&lt;!--[if !vml]--&gt;<span style="margin-top: 214px;margin-left: 10px;width: 268px;height: 52px"></span><a href="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce1.jpg"><img height="388" alt="clickonce1" src="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce1-thumb.jpg" width="485" border="0" /></a> </p>  <p><i>Figure 1</i>. Prerequisites of the    <br />application listed in the Publish ClickOnce html file</p>  <p class="MsoNormal"><a href="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce2.jpg"><img height="379" alt="clickonce2" src="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce2-thumb.jpg" width="312" border="0" /></a> </p>  <p class="MsoNormal"><i>Figure 2</i>. Pressing    <br />Install will launch the bootstrapper that detects the uninstalled    <br />prerequisites: Net Framework 2.0 and WinFx Runtime Components Beta 2</p>  <p class="MsoNormal"><a href="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce3.jpg"><img height="159" alt="clickonce3" src="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce3-thumb.jpg" width="374" border="0" /></a>&#160; <br /><i>Figure 3</i>. The setup downloads the prerequisites from a specific location</p>  <p class="MsoNormal"><a href="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce4.jpg"><img height="159" alt="clickonce4" src="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce4-thumb.jpg" width="368" border="0" /></a> </p>  <p><!--[if gte vml 1]&gt;-->   <br />    <br />&lt;!--[if !vml]--&gt;&lt;!--[endif]--&gt;</p>  <p class="MsoNormal"><i>Figure 4</i>. After    <br />downloading, the setup will install the WinFx Runtime Components</p>  <p class="MsoNormal"></p>  <p class="MsoNormal"></p>  <h3><a name="_Toc129597700">Using WCF on your application requires more     <br />CAS permissions (FullTrust)</a></h3>  <p class="MsoNormal">In many real scenarios, developers need their applications   <br />to run as a Partial Trust Application, but need more permissions. For example,    <br />you may need to use a SQL Client. To solve this kind of problems, ClickOnce introduces a feature called <b>Permission     <br />Elevation</b>, which allows an application without enough permissions to    <br />request them to the user. If the user accepts, then the needed permissions are    <br />granted and the application can run normally. This could goes up till    <br />FullTrust which is the requirement for WCF. Besides, in scenarios in which users should not make these kinds of    <br />decisions, a practical solution is offered: system administrators can sign the    <br />application manifests or set a deployment policy that specifies that a    <br />publisher is a trusted source. This way, permissions will automatically be    <br />granted before the application loads.</p>  <p class="MsoNormal"><a href="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce5.jpg"><img height="259" alt="clickonce5" src="http://blogs.southworks.net/mwoloski/files/2008/06/clickonce5-thumb.jpg" width="475" border="0" /></a> </p>  <p><i>Figure 5</i>. Installing the application and permission elevation</p>  <h3>Creating the prerequisites </h3>  <p class="MsoNormal">WinFx does not come as a prerequisite in the   <br />Visual Studio 2005 Publish tab. However, we can create our own    <br />prerequisite with any MSI or EXE installation.</p>  <p class="MsoNormal">The process to do this is:</p>  <ol>   <li>Create a new folder called &quot;WinFx&quot; here %Program Files%\Microsoft Visual Studio 8\SDK\v2.0\BootStrapper\Packages </li>    <li>Use the <a href="http://www.gotdotnet.com/workspaces/workspace.aspx?id=ddb4f08c-7d7c-4f44-a009-ea19fc812545">Bootstrapper Manifest Generator</a> to create the manifest for WinFx. <a href="http://www.southworks.net/matiaswoloski/content/binary/BootstrapperManifest.zip">I've created it already for WinFx.</a> </li>    <li>Copy the manifest to %Program Files%\Microsoft Visual Studio 8\SDK\v2.0\BootStrapper\Packages\WinFx </li>    <li>Copy the WinFx Runtime Components redistributable to the same folder </li>    <li>Restart Visual Studio 2005 </li> </ol>  <p class="MsoNormal">More resources</p>  <ul style="margin-top: 0cm" type="disc">   <li class="MsoNormal">Adding     <br />Custom Prerequisites: <span>&#160;</span><a href="http://msdn2.microsoft.com/en-us/library/ms165429.aspx">http://msdn2.microsoft.com/en-us/library/ms165429.aspx</a> </li>    <li class="MsoNormal">How     <br />to: Install Prerequisites with a ClickOnce Application: <a href="http://msdn2.microsoft.com/en-us/library/8st7th1x.aspx">http://msdn2.microsoft.com/en-us/library/8st7th1x.aspx</a> </li>    <li class="MsoNormal">Brian Noyes ClickOnce article, <a title="http://msdn.microsoft.com/msdnmag/issues/04/05/clickonce/default.aspx" href="http://msdn.microsoft.com/msdnmag/issues/04/05/clickonce/default.aspx">http://msdn.microsoft.com/msdnmag/issues/04/05/clickonce/default.aspx</a> </li>    <li class="MsoNormal">Security     <br />Considerations for ClickOnce Deployments: <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dv_vstechart/html/ClickOnceSec.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dv_vstechart/html/ClickOnceSec.asp</a>      <br /></li>    <li class="MsoNormal">ClickOnce     <br />Deployment and Security: <a href="http://msdn2.microsoft.com/en-us/library/76e4d2xw.aspx">http://msdn2.microsoft.com/en-us/library/76e4d2xw.aspx</a> </li> </ul>  <p class="MsoNormal"></p>
