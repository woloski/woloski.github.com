--- 
layout: post
title: "Tankster \xE2\x80\x93 the story behind - Node.js + HTML5 + Windows Azure \xE2\x80\x93 BUILD Windows 8"
published: false
meta: 
  _edit_last: "24"
  _edit_lock: "1316009529"
  _wp_old_slug: ""
tags: 
- Architecture
- Azure
- HTML5
- Node.js
type: post
status: draft
---
<p>The Wednesday keynote on the BUILD&nbsp; conference showcased <a href="http://www.tankster.net/">tankster</a>, a social HTML5 game that we helped to create together with Microsoft DPE and <a href="http://www.gskinner.com">gskinner</a>.</p> <p>Couple of months ago <a href="https://twitter.com/#!/jamescon">James Conard</a>, <a href="http://www.wadewegner.com/">Wade Wegner</a> and <a href="http://ntotten.com/">Nathan Totten</a> from the DPE team, gave us one of those unique opportunities as software engineers where you can dive into a ne<a href="http://blogs.southworks.net/mwoloski/files/2011/09/image.png"><img style="border-right-width: 0px;padding-left: 0px;padding-right: 0px;float: right;border-top-width: 0px;border-bottom-width: 0px;border-left-width: 0px;padding-top: 0px" border="0" alt="image" align="right" src="http://blogs.southworks.net/mwoloski/files/2011/09/image_thumb.png" width="380" height="144"></a>w problem space and enjoy the freedom of choosing the technologies and the architecture to solve that problem. This time together with a great team* we delved into social games. </p> <p>One of the first things we did with the team was analyzing what are the pieces that made social games (from a technical perspective). Based on the <a href="http://blogs.southworks.net/jhalife/2010/06/23/windows-azure-performance-gotchas-1-raising-the-throughput-reducing-the-headache/">experience we had</a> helping optimizing <a href="http://www.facebook.com/playbola">Bola</a>, we knew we could help to tell the story on how to create scalable and maintainable social games.&nbsp;&nbsp; </p> <h2>How it all started…</h2> <p>Back in July, <a href="http://ntotten.com/">Nate</a> came up with a detailed spec of <a href="http://www.tankster.net/">Tankster</a> (at that time called Siege of Aperion). We analyzed all the APIs that were required for the game to work and categorized like the following illustration.</p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/09/image1.png"><img style="border-right-width: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px;border-bottom-width: 0px;border-left-width: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/09/image_thumb1.png" width="684" height="526"></a></p> <p>&nbsp;</p> <p>&nbsp;</p> <p>In more detail…</p> <blockquote> <p><strong><font size="4">Game Play<br></font></strong>we called Game Play to the interactions of the real-time multiplayer game (like firing, chatting, etc.) </p> <p><strong><font size="4">Game Front End<br></font></strong>the game front end will handle everything else (authentication, inviting friends, etc.)</p><strong><font size="4">Game Statistics<br></font></strong>a critical part of the game is collecting statistics of the users playing and show those somewhere (leaderboard, analytics, etc.)</blockquote> <h2>Design decisions</h2> <ul> <li>We separated these three things (game play, front end, statistics), so each can scale independently from each other. It’s not the same to scale the “real-time” interaction and the statistics. They have different interactions.</li> <li>We started implementing the game backend (consisting of the 3 pieces shown in the diagram) and <a href="http://gskinner.com">gskinner</a> developed the HTML5 client. We made a good decision from the ground that was supporting cross domain so they can work on the client and point to our server that hosted the APIs. This allowed both teams to work independently and just agree on the interfaces. I <a href="http://blogs.southworks.net/mwoloski/2011/07/02/ajax-cross-domain-jquery-wcf-web-api-or-mvc-windows-azure/">blogged about that back then</a>.</li> <li>Another good decision we made was to make the server as generic as possible so that it doesn’t have any logic related to the game. All the logic is handled by the client and we didn’t interfere in that.</li></ul> <p>If you want to read more about this first version and some of the insights on the backend, I recommend you to read <a href="http://ajlopez.wordpress.com/">Angel</a>’s blog. He was one of the developers working on this and wrote a series of posts about the first version of the game: <a href="http://ajlopez.wordpress.com/2011/07/18/social-online-games-programming-part-1-introduction/">part 1</a>, <a href="http://ajlopez.wordpress.com/2011/07/21/social-online-games-programming-part-2-tankster-and-windows-azure-toolkit-for-social-games/">part 2</a>, <a href="http://ajlopez.wordpress.com/2011/07/29/social-online-games-programming-part-3-tankster-blob-storage-and-jsonp/">part 3</a>.</p> <h2>Couple of months later…</h2> <p>In the <strong>first release </strong>of the <a href="http://watgames.codeplex.com/">Toolkit for Social Games</a> for the Game Play we decided to use a pull model where browsers would call the web API and the server would update a file in blob storage wit<a href="http://blogs.southworks.net/mwoloski/files/2011/09/image2.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;float: right;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" align="right" src="http://blogs.southworks.net/mwoloski/files/2011/09/image_thumb2.png" width="244" height="64"></a>h the game state as a JSONP object that would then be pulled from the client every 1 second. This allowed us to drive the concurrency of the polling to blob storage and delegate the heavy duty of the millions of pollings to Windows Azure blob storage scalability. <a href="http://ntotten.com/2011/07/architecture-of-tankster-scale-part-2/">Nathan wrote about this</a> approach and also about the shortcomings.&nbsp; You can see this approach in action for instance when a user joins the game queue to wait other participants. Notice the first is a POST to /Game/Queue and then the client starts polling to the blob storage. Every time a new client joins the game, the blob <em>28e105cb-40e4-4486-8ab2-5643830042c9</em> will be updated with the new player.</p> <p>&nbsp;</p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/09/image3.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/09/image_thumb3.png" width="801" height="85"></a></p> <h2>Today at BUILD…</h2> <p>In this <strong>new release </strong>shown in Today’s keynote, we moved the Game Play to <strong>node.js</strong> and <strong>socket.io.</strong> Node.js <a href="http://blog.nodejs.org/2011/06/23/porting-node-to-windows-with-microsoft%E2%80%99s-help/">recently announced</a> a version that was compiled for Windows. Sin<a href="http://blogs.southworks.net/mwoloski/files/2011/09/image4.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;float: right;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" align="right" src="http://blogs.southworks.net/mwoloski/files/2011/09/image_thumb4.png" width="244" height="71"></a>ce the server is dumb enough to just relay commands and don’t interfere in the game logic (a “hub” model), we moved from one approach to the other in a matter of days. We added socket.io in the mix so we had a fallback mechanism for browsers not supporting WebSockets today (for instance IE9 will fallback to long polling). The nice thing about socket.io is that it abstract out the transports and you can rely on a unified socket API. Below you can see the WebSockets in action used in Chrome for Mac. Notice the url of the web socket <strong>ws://tankster-prod-nodejs.cloudapp.net</strong>. This is an Extra Large instance running a worker role that launches a node.js server. Read <a href="http://ntotten.com/2011/08/nodejs-on-windows-azure/">Nathan blog</a> if you want to know how to setup something like this.</p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/09/image7.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/09/image_thumb7.png" width="768" height="369"></a></p> <p>&nbsp;</p> <p>During the Keynote the Windows 8 Metro-style version and a Windows Phone version have been shown. Both of them used the same backend API and the Node.js server. Since WP7 does not support the WebScokets protocol and there is no library out there yet we just used regular sockets and did a bridge between the two types of sockets. </p> <p>So in essence, this is how the architecture of the game ended up looking like from a high level view.</p> <p>&nbsp;</p> <p>&nbsp;</p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/09/image11.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/09/image_thumb11.png" width="715" height="463"></a></p> <p>&nbsp;</p> <p>This is how it looks in the Windows Azure portal: </p> <p><a href="http://blogs.southworks.net/mwoloski/files/2011/09/image9.png"><img style="border-bottom: 0px;border-left: 0px;padding-left: 0px;padding-right: 0px;border-top: 0px;border-right: 0px;padding-top: 0px" border="0" alt="image" src="http://blogs.southworks.net/mwoloski/files/2011/09/image_thumb9.png" width="488" height="526"></a></p> <p>&nbsp;</p> <h2>Next…</h2> <p>In the next couple of weeks there will be more to unveil about the source code and architecture. For now, you can play the game online at <a href="http://www.tankster.net">www.tankster.net</a> <img style="border-bottom-style: none;border-left-style: none;border-top-style: none;border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="http://blogs.southworks.net/mwoloski/files/2011/09/wlEmoticon-smile.png"></p> <p><em>* Credits to the dev team: the first version developed by Sebastian Iacomuzzi and </em><a href="http://blogs.southworks.net/dgeffner"><em>Diego Geffner</em></a><em>. Then Marcelo Rodriguez and </em><a href="http://ajlopez.wordpress.com/"><em>Angel Lopez</em></a> adding more features and the port to nodejs.<em> We’ve also had some help from </em><a href="http://blogs.southworks.net/sdurandeu"><em>Sebastian Durandeu</em></a><em> and </em><a href="http://blogs.southworks.net/jcisneros"><em>Jony Cisneros</em></a><em> during ship mode for the leaderboards and statistics.</em></p>
